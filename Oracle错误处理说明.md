# Oracle错误处理说明

## 错误信息

```
ORA-01722: 无效数字
```

## 错误原因

Oracle数据库在尝试将字符串转换为数字时，如果字符串包含非数字字符或格式不正确，就会抛出此错误。

## 常见原因

1. **数字字段包含非数字字符**
   - ❌ `"goodsid": "28075A"` （包含字母）
   - ❌ `"goodsqty": "5.5"` （如果字段要求整数）
   - ❌ `"customid": "22198 "` （包含空格）

2. **数字字段为空或null**
   - ❌ `"goodsid": ""`
   - ❌ `"goodsqty": null`

3. **数据类型不匹配**
   - ❌ `"customid": 22198` （应该是字符串）
   - ✅ `"customid": "22198"` （正确格式）

## 解决方案

### 1. 数据格式标准化

服务器已添加 `normalizeOrderData()` 函数，自动处理：

- ✅ 所有数字字段转换为字符串
- ✅ 验证数字字段是否为有效数字
- ✅ 移除数字字段中的非数字字符
- ✅ 确保所有必填字段不为空

### 2. 数据格式要求

**主单字段**（必须为字符串）：
```json
{
  "customid": "7016",        // ✅ 字符串
  "entryid": "1",            // ✅ 字符串
  "inputmanid": "9631",      // ✅ 字符串
  "assesscustomid": "656"    // ✅ 字符串
}
```

**明细字段**（必须为字符串）：
```json
{
  "connodtlid": "2300018756177377",  // ✅ 字符串，纯数字
  "goodsid": "6770",                 // ✅ 字符串，纯数字
  "goodsqty": "5"                    // ✅ 字符串，纯数字
}
```

### 3. 验证检查清单

在发送数据前，确保：

- [ ] 所有数字字段都是字符串类型
- [ ] 所有数字字段只包含数字字符（0-9）
- [ ] 所有数字字段不为空
- [ ] `goodsqty` 必须是正整数（不能是小数）
- [ ] `connodtlid`、`goodsid` 必须是有效的数字字符串

## 测试数据格式

### ✅ 正确格式

```json
{
  "businessType": "DS01",
  "conno": "HBS-120260127088",
  "customid": "7016",
  "memo": "",
  "credate": "2026-01-27 00:00:00",
  "entryid": "1",
  "inputmanid": "9631",
  "assesscustomid": "656",
  "detailList": [
    {
      "conno": "HBS-120260127088",
      "connodtlid": "2300018756177377",
      "goodsid": "6770",
      "goodsqty": "5",
      "dtlmemo": ""
    }
  ]
}
```

### ❌ 错误格式示例

```json
{
  // ❌ 错误：数字类型
  "customid": 7016,
  
  // ❌ 错误：包含空格
  "entryid": "1 ",
  
  // ❌ 错误：包含非数字字符
  "goodsid": "6770A",
  
  // ❌ 错误：空字符串
  "goodsqty": "",
  
  // ❌ 错误：null值
  "connodtlid": null
}
```

## 服务器端处理

服务器会自动：

1. **转换数据类型**：将所有数字字段转换为字符串
2. **验证数字格式**：确保只包含数字字符
3. **清理数据**：移除空格和非数字字符
4. **错误提示**：如果数据格式不正确，返回详细错误信息

## 日志输出

服务器会输出转换后的数据：

```
✅ 订单数据验证通过，包含 1 个明细项
转换后的数据: {
  "businessType": "DS01",
  "conno": "HBS-120260127088",
  "customid": "7016",
  ...
}
```

## 调试步骤

如果仍然遇到错误：

1. **检查服务器日志**
   ```bash
   # 查看转换后的数据格式
   # 确认所有数字字段都是字符串
   ```

2. **验证数据**
   ```bash
   # 使用测试脚本
   node test_detailList.js
   ```

3. **检查ERP字段要求**
   - 确认ERP数据库中字段的数据类型
   - 确认是否有字段长度限制
   - 确认是否有特殊格式要求

4. **联系ERP管理员**
   - 提供完整的错误信息
   - 提供发送的数据格式
   - 确认ERP端的字段定义

## 预防措施

1. **前端验证**：在提交前验证所有数字字段
2. **服务器验证**：服务器端进行二次验证和转换
3. **日志记录**：记录所有发送的数据，便于排查
4. **错误处理**：提供详细的错误信息

## 相关文件

- `server.js` - 包含数据标准化函数
- `test_detailList.js` - 测试脚本
- `数据格式说明.md` - 完整的数据格式文档








